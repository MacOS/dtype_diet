---

title: dtype_diet


keywords: fastai
sidebar: home_sidebar

summary: "Attempt to shrink Pandas `dtypes` without losing data so you have more RAM (and maybe more speed)"
description: "Attempt to shrink Pandas `dtypes` without losing data so you have more RAM (and maybe more speed)"
nb_path: "index.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This file will become your README and also the index of your documentation.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install">Install<a class="anchor-link" href="#Install"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>pip install dtype_diet</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-use">How to use<a class="anchor-link" href="#How-to-use"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>TBD</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>This is a fork of <a href="https://github.com/ianozsvald/dtype_diet">https://github.com/ianozsvald/dtype_diet</a> to continue supoprt and develop the library with approval from the original author @ianozsvald.</p>
</blockquote>
<p>Status - early alpha, written in 2 hours on a Sunday. Suggestions welcome, I may accept PRs but you're better off asking first (via a bug report) with the suggestion in case it isn't where I want to take the library. I'm also very happy to have "Thanks" posted via bugs too if this helps you out :-)</p>
<p>This tool checks each column to see if larger dtypes (e.g. 8 byte <code>float64</code> and <code>int64</code>) could be shrunk to smaller <code>dtypes</code> without causing any data loss. 
Dropping an 8 byte type to a 4 (or 2 or 1 byte) type will keep halving the RAM requirement for that column.  Categoricals are proposed for <code>object</code> columns which can bring significant speed and RAM benefits.</p>
<p>Whilst working on the <a href="https://www.goodreads.com/book/show/49828191-high-performance-python">2nd edition of High Performance Python</a> with Micha Gorelick I wrote on RAM reduction in the Using Less RAM chapter for Pandas and NumPy and I wanted to write a tool like this, but didn't have time (heck, writing the 2nd edition took 9 months!). So, I got to write this tool after publication instead.</p>
<p>Here's an example (see Notebook: <a href="example_sell_prices_ram_shrinkage.ipynb">example_sell_prices_ram_shrinkage.ipynb</a> ) on a Kaggle dataset showing a reduction of 957 -&gt; 85MB:</p>
<p><img src="/dtype_diet/example_sell_prices.png" alt="sell_prices after dtype_dtype"></p>
<p>Recommendations:</p>
<ul>
<li>Run <code>report_on_dataframe(your_df)</code> to get recommendations</li>
<li>Consider if Categoricals will save you RAM (see Caveats below)</li>
<li>Consider if f32 or f16 will be useful (see Caveats - f32 is <em>probably</em> a reasonable choice unless you have huge ranges of floats)</li>
<li>Consider if int32, int16, int8 will be useful (see Caveats - overflow may be an issue)</li>
<li>Look at <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.convert_dtypes.html">https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.convert_dtypes.html</a> which recommends Pandas nullable dtype alternatives (e.g. to avoid promoting an int64 with NaN items to float64, instead you get Int64 with NaNs and no data loss)</li>
<li>Look at Extension arrays like <a href="https://github.com/JDASoftwareGroup/rle-array">https://github.com/JDASoftwareGroup/rle-array</a> (thanks @repererum <a href="https://twitter.com/crepererum/status/1267441357339201536">for the tweet</a>)</li>
</ul>
<p>Look at <code>__main__</code> and try <code>report_on_dataframe(your_df)</code> to get a printed report - no changes are made to your dataframe.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Usage">Usage<a class="anchor-link" href="#Usage"> </a></h2><h3 id="CLI">CLI<a class="anchor-link" href="#CLI"> </a></h3><div class="highlight"><pre><span></span>$ rm -f dtype_diet.py
$ wget https://raw.githubusercontent.com/ianozsvald/dtype_diet/master/dtype_diet.py
</pre></div>
<h3 id="Notebook">Notebook<a class="anchor-link" href="#Notebook"> </a></h3><div class="highlight"><pre><span></span>%%bash
rm -f dtype_diet.py
wget https://raw.githubusercontent.com/ianozsvald/dtype_diet/master/dtype_diet.py
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Source-file/Notebook-cell">Source file/Notebook cell<a class="anchor-link" href="#Source-file/Notebook-cell"> </a></h3><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dtype_diet</span>
<span class="o">...</span><span class="p">(</span><span class="k">for</span> <span class="n">rest</span> <span class="n">of</span> <span class="n">the</span> <span class="n">usage</span> <span class="n">example</span> <span class="n">see</span> <span class="n">notebook</span> <span class="n">mention</span> <span class="ow">in</span> <span class="n">previous</span> <span class="n">section</span><span class="p">)</span><span class="o">...</span>
</pre></div>
<h1 id="example-run-on-a-made-up-dataframe-in-main">example run on a made-up dataframe in <strong>main</strong><a class="anchor-link" href="#example-run-on-a-made-up-dataframe-in-main"> </a></h1>
<pre><code>dtype_diet$ python dtype_diet.py 
Given a dataframe, check for lowest possible conversions:
Smallest non-breaking converstion per column:
a (int64) currently taking 928 bytes, to save 700 bytes try `a.astype(int8)`
b (int64) currently taking 928 bytes, to save 600 bytes try `b.astype(int16)`
c (int64) currently taking 928 bytes, to save 400 bytes try `c.astype(int32)`
d (float64) currently taking 928 bytes, to save 600 bytes try `d.astype(float16)`
e (float64) currently taking 928 bytes, to save 400 bytes try `e.astype(float32)`
str_a (object) currently taking 6,328 bytes, to save 5,958 bytes try `str_a.astype(category)`
str_b (object) currently taking 6,018 bytes - no suggestion</code></pre>
<h2 id="Caveats">Caveats<a class="anchor-link" href="#Caveats"> </a></h2><ul>
<li>reduced numeric ranges might lead to overflow (TODO document)</li>
<li>category dtype can have unexpected effects e.g. need for observed=True in groupby (TODO document)</li>
<li>f16 is likely to be simulated on modern hardware so calculations will be 2-3* slower than on f32 or f64</li>
<li>we could do with a link that explains binary representation of float &amp; int for those wanting to learn more</li>
</ul>
<h2 id="Development">Development<a class="anchor-link" href="#Development"> </a></h2><p>There's a bunch of interesting notes in the initial Tweet I sent out: <a href="https://twitter.com/ianozsvald/status/1267129298646941696">https://twitter.com/ianozsvald/status/1267129298646941696</a> (thanks to all who replied).</p>
<h3 id="Releases">Releases<a class="anchor-link" href="#Releases"> </a></h3><p>Run <code>pytest dtype_diet.py</code> (better yet - add more tests!). Push to github.</p>
<h3 id="Contributors">Contributors<a class="anchor-link" href="#Contributors"> </a></h3><ul>
<li>Antony Milbourne <a href="https://github.com/amilbourne">https://github.com/amilbourne</a></li>
<li>Mani <a href="https://github.com/neomatrix369">https://github.com/neomatrix369</a></li>
</ul>
<h3 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h3>
<pre><code>$ conda create -n dtype_diet python=3.8 pandas jupyter pyarrow pytest
$ conda activate dtype_diet</code></pre>
<h1 id="Contributing">Contributing<a class="anchor-link" href="#Contributing"> </a></h1><p>The repository is developed with <code>nbdev</code>, a system for developing library with notebook.</p>
<p>Make sure you run this if you want to contribute to the library. For details, please refer to nbdev documentation (<a href="https://github.com/fastai/nbdev">https://github.com/fastai/nbdev</a>)</p>

<pre><code>nbdev_install_git_hooks</code></pre>
<p>Some other useful commands</p>

<pre><code>nbdev_build_docs
nbdev_test_nbs</code></pre>

</div>
</div>
</div>
</div>
 

